name: Production Stage

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
      - name: Create Release
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          name: Lumio Player ${{ github.ref_name }}
          body: |
            ## ðŸŽ‰ New Release: ${{ github.ref_name }}

            ### ðŸ“º Lumio Player
            A modern, cross-platform IPTV player application built with Flutter.

            ### ðŸ“± Supported Platforms
            - âœ… Windows (x64)
            - âœ… macOS (Universal)
            - âœ… Linux (x64)
            - âœ… Android (APK)
            - âœ… iOS (No Codesign)
            - âœ… Web

            ### ðŸ“¥ Downloads
            Download the appropriate version for your platform below.

            ### ðŸ”„ Auto-generated from CI/CD
            This release was automatically created with artifacts from our production pipeline.
          draft: false
          prerelease: false
          generateReleaseNotes: true
          makeLatest: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-android-prod:
    name: Build Android (Prod)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build Android APK
        run: flutter build apk --release
      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk lumio-android-${{ github.ref_name }}.apk
      - name: Upload Android Release Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: lumio-android-${{ github.ref_name }}.apk
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-windows-prod:
    name: Build Windows (Prod)
    needs: create-release
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build Windows
        run: flutter build windows
      - name: Install NSIS
        run: choco install nsis -y
      - name: Create Windows Installer
        shell: pwsh
        run: |
          cd windows
          $makensis = "${env:ProgramFiles(x86)}\NSIS\makensis.exe"
          if (!(Test-Path $makensis)) {
             throw "makensis not found at $makensis"
          }
          & $makensis installer.nsi
          if (Test-Path "lumio-windows-setup.exe") {
             Move-Item "lumio-windows-setup.exe" "..\lumio-windows-setup-${{ github.ref_name }}.exe"
          } else {
             throw "Installer file not found!"
          }
      - name: Create Windows Zip
        run: |
          cd build/windows/x64/runner/Release
          7z a ../../../../../lumio-windows-${{ github.ref_name }}.zip .
      - name: Upload Windows Release Assets
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: |
            lumio-windows-setup-${{ github.ref_name }}.exe
            lumio-windows-${{ github.ref_name }}.zip
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-linux-prod:
    name: Build Linux (Prod)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev \
            libasound2-dev libpulse-dev libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libunwind-dev libmpv-dev mpv libavcodec-dev libavformat-dev libavutil-dev \
            libswscale-dev libavfilter-dev libavdevice-dev libswresample-dev
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build Linux
        run: flutter build linux
      - name: Create Linux Archive
        run: |
          cd build/linux/x64/release/bundle
          zip -r ../../../../../lumio-linux-${{ github.ref_name }}.zip .
      - name: Upload Linux Release Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: lumio-linux-${{ github.ref_name }}.zip
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-ios-prod:
    name: Build iOS (Prod)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Install CocoaPods
        run: sudo gem install cocoapods
      - name: Install iOS dependencies
        run: cd ios && pod install
      - name: Build iOS
        run: flutter build ios --no-codesign
      - name: Create iOS Archive
        run: |
          cd build/ios/iphoneos
          zip -r ../../../lumio-ios-${{ github.ref_name }}.zip .
      - name: Upload iOS Release Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: lumio-ios-${{ github.ref_name }}.zip
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-macos-prod:
    name: Build macOS (Prod)
    needs: create-release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build macOS
        run: flutter build macos
      - name: Create macOS Archive
        run: |
          cd build/macos/Build/Products/Release
          zip -r ../../../../../lumio-macos-${{ github.ref_name }}.zip .
      - name: Upload macOS Release Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: lumio-macos-${{ github.ref_name }}.zip
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}

  build-web-prod:
    name: Build Web (Prod)
    needs: create-release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'
          channel: 'stable'
      - name: Install dependencies
        run: flutter pub get
      - name: Generate files
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
      - name: Build Web
        run: flutter build web --release
      - name: Create Web Archive
        run: |
          cd build/web
          zip -r ../../lumio-web-${{ github.ref_name }}.zip .
      - name: Upload Web Release Asset
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ github.ref_name }}
          artifacts: lumio-web-${{ github.ref_name }}.zip
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}
